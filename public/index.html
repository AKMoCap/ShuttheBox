<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Shut the Box</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="header-container">
    <h1>SHUT THE BOX</h1>
    <div class="play-mode-buttons">
      <button id="freePlayBtn" class="mode-btn active">Free Play</button>
      <div class="perpplay-wrapper">
        <button id="perpPlayBtn" class="mode-btn">PerpPlay - Connect Wallet</button>
        <div id="signatureHint" class="wallet-hint">2 one-time signatures</div>
        <div id="walletAddress" class="wallet-hint" style="display: none;"></div>
      </div>
      <button id="disconnectBtn" class="mode-btn disconnect-btn" style="display: none;">Disconnect</button>
      <button id="soundToggle" class="mode-btn sound-btn">üîá Sound</button>
    </div>
  </div>

  <!-- GAME + SIDEBARS FLEX -->
  <div class="game-container">
    <!-- LEFT COLUMN: odds, remaining total, dice selectors (desktop only) -->
    <div class="left-container">
      <div id="immediateOddsDisplay" class="odds-display">
        <div class="odds-label">Odds to Survive:</div>
        <div class="odds-value"><span id="immediateOdds">‚Ä¶</span></div>
      </div>
      <div id="scoreBarDesktop" class="score-bar-desktop">Remaining Total: <span id="remainingDesktop">78</span></div>
      <div id="controlsDesktop" class="controls-desktop">
        <label><input type="radio" name="diceModeDesktop" value="1"> 1 Die</label>
        <label><input type="radio" name="diceModeDesktop" value="2" checked> 2 Dice</label>
      </div>
    </div>

    <!-- BOARD WRAP: canvas + dice result + roll button -->
    <div id="boardWrap">
      <canvas id="board" width="900" height="660"></canvas>
      <div id="diceResult"></div>
      <button id="rollBtn" class="primary">ROLL</button>

      <!-- Position table for PerpPlay mode -->
      <div id="positionTableContainer" class="position-table-container" style="display: none;">
        <div class="position-table-header">
          <span>Open Positions</span>
          <button id="endGameBtn" class="end-game-btn">End Game</button>
        </div>
        <table id="positionTable" class="position-table">
          <thead>
            <tr>
              <th>Token</th>
              <th>Side</th>
              <th>Lev</th>
              <th>Collateral</th>
              <th>Entry</th>
              <th>Mark</th>
              <th>P&L</th>
            </tr>
          </thead>
          <tbody id="positionTableBody">
          </tbody>
          <tfoot id="positionTableFooter" style="display: none;">
            <tr>
              <td colspan="6" class="total-label">Total P&L:</td>
              <td id="totalPnl" class="total-pnl">$0.00</td>
            </tr>
          </tfoot>
        </table>
        <div id="noPositionsMsg" class="no-positions-msg">No open positions</div>
      </div>
    </div>

    <!-- RIGHT COLUMN: collateral selector, controls -->
    <div class="right-container">
      <!-- Collateral selector - only shown in PerpPlay mode -->
      <div id="collateralSection" class="collateral-section" style="display: none;">
        <div class="collateral-label">Perp Collateral:</div>
        <div id="userBalanceDisplay" class="user-balance">$0.00</div>
        <div class="collateral-roll-label">Collateral Per Roll:</div>
        <div class="collateral-buttons">
          <button class="collateral-btn active" data-amount="10">$10</button>
          <button class="collateral-btn" data-amount="100">$100</button>
          <button class="collateral-btn" data-amount="500">$500</button>
          <button class="collateral-btn" data-amount="1000">$1,000</button>
        </div>
      </div>

      <!-- Odds display (mobile only - desktop version is in left-container) -->
      <div id="immediateOddsDisplayMobile" class="odds-display mobile-only">
        <div class="odds-label">Odds to Survive:</div>
        <div class="odds-value"><span id="immediateOddsMobile">‚Ä¶</span></div>
      </div>

      <!-- Desktop-only controls cheat-sheet -->
      <div id="controlsBox" class="controls-box">
        <strong>Keyboard Controls</strong><br>
        Enter ‚Äì Roll<br>
        Arrows ‚Äì Select Cards<br>
        Spacebar ‚Äì Flip/Unflip<br>
        Ctrl + R ‚Äì Restart
      </div>
    </div>
  </div>

  <!-- bottom controls (mobile only) -->
  <div id="scoreBar" class="mobile-only">Remaining Total: <span id="remaining">78</span></div>
  <div id="controls" class="mobile-only">
    <label><input type="radio" name="diceMode" value="1"> 1 Die</label>
    <label><input type="radio" name="diceMode" value="2" checked> 2 Dice</label>
  </div>

  <!-- New instructions box -->
  <div id="instructions">
    <strong>Instructions:</strong>
    <p>
      The goal of the game is to "shut the box" by rolling dice to turn over every card.
      For example, if you roll a 7, it is your choice to turn over the 7 card, or any combination of cards that adds to
      7.
      If you are down to single digit cards, you have the choice to roll just 1 die.
    </p>
    <p>Good luck!</p>
  </div>

  <!-- Stats button -->
  <button id="statsBtn" class="stats-btn">Stats</button>

  <!-- Leaderboard -->
  <div id="leaderboardSection" class="leaderboard-section">
    <h3>Leaderboard (Top 100)</h3>
    <div class="leaderboard-table-container">
      <table class="leaderboard-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Wallet</th>
            <th>Points</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody">
          <tr><td colspan="3">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Stats Modal -->
  <div id="statsModal" class="stats-modal" style="display: none;">
    <div class="stats-modal-content">
      <button id="closeStatsModal" class="close-stats-modal">&times;</button>

      <!-- Free Play Stats -->
      <div class="stats-section-box">
        <h3>Free Play Stats</h3>
        <table class="stats-table">
          <tr>
            <td>Total Players</td>
            <td><span id="fpTotalPlayers">0</span></td>
          </tr>
          <tr>
            <td>Total Wins</td>
            <td><span id="fpTotalWins">0</span></td>
          </tr>
          <tr>
            <td>Total Losses</td>
            <td><span id="fpTotalLosses">0</span></td>
          </tr>
          <tr class="your-stats-row">
            <td>Your Wins</td>
            <td><span id="fpYourWins">0</span></td>
          </tr>
          <tr class="your-stats-row">
            <td>Your Losses</td>
            <td><span id="fpYourLosses">0</span></td>
          </tr>
        </table>
      </div>

      <!-- PerpPlay Stats -->
      <div class="stats-section-box">
        <h3>PerpPlay Stats</h3>
        <table class="stats-table">
          <tr>
            <td>Total Wallets Played</td>
            <td><span id="ppTotalWallets">0</span></td>
          </tr>
          <tr>
            <td>Total Wins</td>
            <td><span id="ppTotalWins">0</span></td>
          </tr>
          <tr>
            <td>Total Losses</td>
            <td><span id="ppTotalLosses">0</span></td>
          </tr>
          <tr class="your-stats-row">
            <td>Your Wins</td>
            <td><span id="ppYourWins">0</span></td>
          </tr>
          <tr class="your-stats-row">
            <td>Your Losses</td>
            <td><span id="ppYourLosses">0</span></td>
          </tr>
          <tr class="your-stats-row">
            <td>Your Volume</td>
            <td><span id="ppYourVolume">$0.00</span></td>
          </tr>
          <tr class="your-stats-row">
            <td>Your P&L</td>
            <td><span id="ppYourPnl">$0.00</span></td>
          </tr>
          <tr class="your-stats-row points-row">
            <td>Your Points</td>
            <td><span id="ppYourPoints">0</span></td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <!-- Trade toast notification for PerpPlay mode -->
  <div id="tradeToast" class="trade-toast" style="display: none;">
    <span id="tradeToastText">Opening BTC 20x LONG with $10...</span>
  </div>

  <!-- Closing positions overlay -->
  <div id="closingOverlay" class="closing-overlay" style="display: none;">
    <div class="closing-content">
      <div id="closingTitle">Closing Positions...</div>
      <div id="closingProgress"></div>
    </div>
  </div>

  <!-- End Game Position Selection Modal -->
  <div id="endGameModal" class="end-game-modal" style="display: none;">
    <div class="end-game-modal-content">
      <h2 id="endGameTitle">Game Over!</h2>
      <p id="endGameSubtitle">Choose which positions to close:</p>
      <div id="endGamePositionsList" class="end-game-positions-list">
        <!-- Positions will be populated dynamically -->
      </div>
      <div class="end-game-totals">
        <span>Total P&L:</span>
        <span id="endGameTotalPnl">$0.00</span>
      </div>
      <div class="end-game-buttons">
        <button id="closeAllPositionsBtn" class="end-game-btn close-all">Close All & End Game</button>
        <button id="keepSelectedBtn" class="end-game-btn keep-selected">Keep Unchecked & New Game</button>
      </div>
    </div>
  </div>

  <!-- Wallet connection modal -->
  <div id="walletModal" class="wallet-modal" style="display: none;">
    <div class="wallet-modal-content">
      <h2>Connect Wallet</h2>
      <p>Connect your wallet to play PerpPlay mode on Hyperliquid</p>
      <div class="wallet-options">
        <button id="connectMetamask" class="wallet-option">
          <span class="wallet-icon">ü¶ä</span>
          <span>MetaMask</span>
        </button>
        <button id="connectRabby" class="wallet-option">
          <span class="wallet-icon">üê∞</span>
          <span>Rabby</span>
        </button>
      </div>
      <button id="closeWalletModal" class="close-modal">Cancel</button>
    </div>
  </div>

  <!-- firebase & game scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/@msgpack/msgpack@3.0.0-beta2/dist.es5+umd/msgpack.min.js"></script>
  <script src="firebase.js"></script>
  <script src="hyperliquid.js"></script>
  <script src="stb.js"></script>
</body>

</html>
